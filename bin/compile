#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

### Configure environment

set -o errexit    # always exit on error
set -o pipefail   # don't ignore exit codes when piping output
unset GIT_DIR     # Avoid GIT_DIR leak from previous build steps

### Constants

# This is used by the buildpack stdlib for metrics
# shellcheck disable=SC2034
BPLOG_PREFIX="buildpack.nodejs"

### Configure directories

ORIG_BUILD_DIR=${1:-}
ORIG_CACHE_DIR=${2:-}
ENV_DIR=${3:-}
BP_DIR=$(cd "$(dirname "${0:-}")"; cd ..; pwd)

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"

for i in "ui" "api" "proxy"
do
    BUILD_DIR="$ORIG_BUILD_DIR/$i"
    CACHE_DIR="$ORIG_CACHE_DIR/$i"
    "$SCRIPT_DIR/compile-subdir"
done

cd $BUILD_DIR; cd ui/ ; npm run build; cd ../


BUILD_DIR="$ORIG_BUILD_DIR"
CACHE_DIR="$ORIG_CACHE_DIR"
./compile-subdir